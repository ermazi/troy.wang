<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="基于hytrix-go的熔断器  流量限制，熔断器，服务降级
 1. 代码示例 package main import ( &#34;errors&#34; &#34;github.com/afex/hystrix-go/hystrix&#34; &#34;log&#34; &#34;net/http&#34; &#34;time&#34; ) func main() { hystrixStreamHandler := hystrix.NewStreamHandler() hystrixStreamHandler.Start() go http.ListenAndServe(&#34;:8074&#34;, hystrixStreamHandler) hystrix.ConfigureCommand(&#34;aaa&#34;, hystrix.CommandConfig{ Timeout: 1000, // 单次请求 超时时间 	MaxConcurrentRequests: 1, // 最大并发量 	SleepWindow: 5000, // 熔断后多久去尝试服务是否可用 	RequestVolumeThreshold: 1, ErrorPercentThreshold: 1, }) for i := 0; i &lt; 10000; i&#43;&#43; { //异步调用使用 hystrix.Go 	err := hystrix.Do(&#34;aaa&#34;, func() error { //test case 1 并发测试 	if i == 0 { return errors."><meta property="og:title" content="hytrix-go" />
<meta property="og:description" content="基于hytrix-go的熔断器  流量限制，熔断器，服务降级
 1. 代码示例 package main import ( &#34;errors&#34; &#34;github.com/afex/hystrix-go/hystrix&#34; &#34;log&#34; &#34;net/http&#34; &#34;time&#34; ) func main() { hystrixStreamHandler := hystrix.NewStreamHandler() hystrixStreamHandler.Start() go http.ListenAndServe(&#34;:8074&#34;, hystrixStreamHandler) hystrix.ConfigureCommand(&#34;aaa&#34;, hystrix.CommandConfig{ Timeout: 1000, // 单次请求 超时时间 	MaxConcurrentRequests: 1, // 最大并发量 	SleepWindow: 5000, // 熔断后多久去尝试服务是否可用 	RequestVolumeThreshold: 1, ErrorPercentThreshold: 1, }) for i := 0; i &lt; 10000; i&#43;&#43; { //异步调用使用 hystrix.Go 	err := hystrix.Do(&#34;aaa&#34;, func() error { //test case 1 并发测试 	if i == 0 { return errors." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troy.wang/docs/golang/posts/circuit-breaker/" />

<title>hytrix-go | /bin/troy.wang</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.6df681b0bb21155cba49f6078e3559216772d8e03e780d240c73ea21817ed5e5.css" integrity="sha256-bfaBsLshFVy6SfYHjjVZIWdy2OA&#43;eA0kDHPqIYF&#43;1eU=">
<script defer src="/en.search.min.98150f84f15670dd15a0308be7f26d10d7474a77213c5fa4f8e042be3c8e8257.js" integrity="sha256-mBUPhPFWcN0VoDCL5/JtENdHSnchPF&#43;k&#43;OBCvjyOglc="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>/bin/troy.wang</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
    <span>Kubernetes</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/kubernetes/posts/argo-rollouts-support-traefik/" class="">argo-rollouts之流量管理添加traefik支持</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/kubernetes/posts/argo-rollouts/" class="">k8s灰度发布神器之argo-rollouts</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/kubernetes/posts/coredns-in-production/" class="">在kubernetes生产环境coredns</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/kubernetes/posts/run-microk8s-on-ubuntu/" class="">在ubuntu上运行microk8s</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="/docs/linux/" class="">linux</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/linux/basic/" class="collapsed ">linux基础知识</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/linux/monitor/" class="collapsed ">监控</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/linux/interview/" class="collapsed ">伪装者</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/linux/bigdata/" class="collapsed ">大数据</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/linux/shell/" class="collapsed ">shell</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="/docs/n9e/" class="">n9e</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/n9e/code/" class="collapsed ">n9e源码学golang</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="/docs/compose/" class="">编排</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/compose/ansible/" class="collapsed ">ansible</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/compose/terraform/" class="collapsed ">terraform</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <span>golang</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/docs/golang/posts/golang-gateway/" class="">golang实现简单网关</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/docs/golang/posts/circuit-breaker/" class="active">hytrix-go</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="/docs/about-me/" class="">关于我</a>
  

          
  
  
  

  
  <ul>
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="/posts/" >
        博客
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>hytrix-go</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-代码示例">1. 代码示例</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="基于hytrix-go的熔断器">基于hytrix-go的熔断器</h1>
<blockquote>
<p>流量限制，熔断器，服务降级</p>
</blockquote>
<h2 id="1-代码示例">1. 代码示例</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;github.com/afex/hystrix-go/hystrix&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">hystrixStreamHandler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">NewStreamHandler</span>()
	<span style="color:#a6e22e">hystrixStreamHandler</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8074&#34;</span>, <span style="color:#a6e22e">hystrixStreamHandler</span>)

	<span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">ConfigureCommand</span>(<span style="color:#e6db74">&#34;aaa&#34;</span>, <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">CommandConfig</span>{
		<span style="color:#a6e22e">Timeout</span>:                <span style="color:#ae81ff">1000</span>, <span style="color:#75715e">// 单次请求 超时时间
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">MaxConcurrentRequests</span>:  <span style="color:#ae81ff">1</span>,    <span style="color:#75715e">// 最大并发量
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">SleepWindow</span>:            <span style="color:#ae81ff">5000</span>, <span style="color:#75715e">// 熔断后多久去尝试服务是否可用
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">RequestVolumeThreshold</span>: <span style="color:#ae81ff">1</span>, 
		<span style="color:#a6e22e">ErrorPercentThreshold</span>:  <span style="color:#ae81ff">1</span>,   
	})

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#75715e">//异步调用使用 hystrix.Go
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#e6db74">&#34;aaa&#34;</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
			<span style="color:#75715e">//test case 1 并发测试
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;service error&#34;</span>)
			}
			<span style="color:#75715e">//test case 2 超时测试
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//time.Sleep(2 * time.Second)
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;do services&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}, <span style="color:#66d9ef">nil</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hystrix err:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;sleep 1 second&#34;</span>)
		}
	}
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}
</code></pre></div><ul>
<li><code>Timeout</code> 单次请求的超时时间,超时进fallback</li>
<li><code>MaxConcurrentRequests</code> 最大并发量，这里是并发，并非QPS</li>
<li><code>SleepWindow</code> 熔断后sleep多久再次尝试服务是否可用</li>
<li><code>RequestVolumeThreshold</code> 判断熔断的最少请求数，默认是10；只有在一个统计窗口内处理的请求数量达到这个阈值，才会进行熔断与否的判断</li>
<li><code>ErrorPercentThreshold</code> 错误百分比达到多少触发熔断</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-代码示例">1. 代码示例</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












